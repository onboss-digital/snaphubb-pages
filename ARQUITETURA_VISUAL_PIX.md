# Arquitetura Visual - PIX com SincronizaÃ§Ã£o Stripe

## 1. Camadas da AplicaÃ§Ã£o

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         FRONTEND (Browser)                       â”‚
â”‚                   app/Livewire/PagePay.blade.php                â”‚
â”‚                                                                   â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚   Seletor de Forma   â”‚              â”‚   Modal de SeleÃ§Ã£o   â”‚ â”‚
â”‚  â”‚  de Pagamento (PIX)  â”‚              â”‚   de FormulÃ¡rio      â”‚ â”‚
â”‚  â”‚                      â”‚              â”‚                      â”‚ â”‚
â”‚  â”‚  [CartÃ£o] [PIX-BR]   â”‚â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â†’ Nome, Email, CPF,    â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â”‚       Telefone               â”‚ â”‚
â”‚         â†“ if 'br'              â”‚       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                â”‚                â†“                â”‚
â”‚                        [Gerar PIX button]                       â”‚
â”‚                                â”‚                                â”‚
â”‚                                â†“                                â”‚
â”‚                    generatePixPayment()                         â”‚
â”‚                          â†“                                      â”‚
â”‚                   preparePIXData()  â†â”€â”€â”€ FONTE DE VERDADE       â”‚
â”‚                    (estrutura dados)      $totals['final_price']â”‚
â”‚                          â†“                                      â”‚
â”‚                   sendPixToBackend()                            â”‚
â”‚                   (POST /api/pix/create)                        â”‚
â”‚                                â”‚                                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                 â”‚
                                 â”‚ HTTP POST
                                 â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      BACKEND (Laravel)                          â”‚
â”‚                                 â”‚                                â”‚
â”‚                                 â†“                                â”‚
â”‚                   PixController@create()                        â”‚
â”‚                                 â”‚                                â”‚
â”‚        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”‚
â”‚        â”‚      VALIDAÃ‡ÃƒO (7 etapas)                       â”‚      â”‚
â”‚        â”‚                                                  â”‚      â”‚
â”‚        â”‚  1. Validar dados (amount, email, plan_key)     â”‚      â”‚
â”‚        â”‚  2. isValidAmountForPlan()                       â”‚      â”‚
â”‚        â”‚     â”œâ”€ Busca: https://snaphubb.com/api/get-plansâ”‚      â”‚
â”‚        â”‚     â”œâ”€ Compara: amount â‰ˆ (plan + bumps)        â”‚      â”‚
â”‚        â”‚     â””â”€ TolerÃ¢ncia: 5%                           â”‚      â”‚
â”‚        â”‚  3. isValidCpf() - verifica dÃ­gitos             â”‚      â”‚
â”‚        â”‚  4. buildPaymentDescription()                   â”‚      â”‚
â”‚        â”‚  5. Mercado Pago API (cria QR code)            â”‚      â”‚
â”‚        â”‚  6. Log de auditoria                            â”‚      â”‚
â”‚        â”‚  7. Retorna dados para frontend                 â”‚      â”‚
â”‚        â”‚                                                  â”‚      â”‚
â”‚        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â”‚
â”‚                                 â”‚                                â”‚
â”‚                                 â†“                                â”‚
â”‚                      JSON Response                             â”‚
â”‚                    (payment_id, QR code)                       â”‚
â”‚                                                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                 â”‚
                                 â”‚ JSON
                                 â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                 FRONTEND (Mostra Modal PIX)                      â”‚
â”‚                                 â”‚                                â”‚
â”‚                                 â†“                                â”‚
â”‚                    showPixModal = true                          â”‚
â”‚                                 â”‚                                â”‚
â”‚        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”‚
â”‚        â”‚     MODAL PIX GERADO COM SUCESSO              â”‚        â”‚
â”‚        â”‚                                                â”‚        â”‚
â”‚        â”‚  [QR CODE IMAGE]                              â”‚        â”‚
â”‚        â”‚                                                â”‚        â”‚
â”‚        â”‚  CÃ³digo: 00020126...                          â”‚        â”‚
â”‚        â”‚  Valor: R$ 29,80                              â”‚        â”‚
â”‚        â”‚  Status: Aguardando Pagamento                 â”‚        â”‚
â”‚        â”‚                                                â”‚        â”‚
â”‚        â”‚  [Copiar CÃ³digo]  [Polling...]               â”‚        â”‚
â”‚        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â”‚
â”‚                                 â”‚                                â”‚
â”‚        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                               â”‚
â”‚        â”‚ Polling: GET /api/pix/status/:payment_id              â”‚
â”‚        â”‚ (a cada 3s verificar se foi pago)                     â”‚
â”‚        â”‚                                                         â”‚
â”‚        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## 2. Fluxo de Dados - SincronizaÃ§Ã£o

```
STRIPE                              PIX
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

API Externa â”€â”€â”
(get-plans)   â”‚
              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                               â”‚                â”‚
                    Frontend: getPlans()
                               â”‚
                    calculateTotals()
                    $totals['final_price'] = "29,80"
                               â”‚
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚                     â”‚
           prepareCheckoutData()   preparePIXData()
           (Stripe token)          (Mercado Pago)
                    â”‚                     â”‚
                    â†“                     â†“
           procesarCheckout()    sendPixToBackend()
              Stripe API         Backend: POST /api/pix/create
                    â”‚                     â”‚
                    â†“                     â†“
           âœ… MESMO VALOR          âœ… MESMO VALOR
           (29,80 BRL)            (2980 centavos)

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
         FONTE DE VERDADE: $totals['final_price']
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
```

---

## 3. ValidaÃ§Ã£o de SeguranÃ§a (Backend)

```
Request chega: 
{
  "amount": 2980,           â† Frontend envia
  "currency_code": "BRL",
  "plan_key": "monthly",
  "cart": [
    {"operation_type": 1, "price": 1990},  â† Plano
    {"operation_type": 2, "price": 990}    â† Bump
  ]
}

Backend valida:
                           
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ isValidAmountForPlan(                   â”‚
â”‚   plan_key: "monthly",                  â”‚
â”‚   amount: 2980,                         â”‚
â”‚   currency_code: "BRL",                 â”‚
â”‚   cart: [...]                           â”‚
â”‚ )                                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
              â”‚
              â”œâ”€â†’ Busca: GET /api/get-plans
              â”‚   Resposta: monthly â†’ R$ 19,90 (1990 centavos)
              â”‚
              â”œâ”€â†’ Soma bumps do cart:
              â”‚   operation_type = 2 â†’ 990 centavos
              â”‚
              â”œâ”€â†’ Total esperado = 1990 + 990 = 2980
              â”‚
              â”œâ”€â†’ Compara:
              â”‚   â”œâ”€ amount_recebido: 2980
              â”‚   â”œâ”€ total_esperado:  2980
              â”‚   â”œâ”€ diferenÃ§a:       0
              â”‚   â””â”€ tolerÃ¢ncia:      5% = 149
              â”‚
              â”œâ”€â†’ 0 â‰¤ 149? SIM âœ…
              â”‚
              â””â”€â†’ return true (vÃ¡lido)

Se falhar: return 422 Unprocessable Entity
           "Valor do pagamento nÃ£o corresponde ao plano"
           
Log: 
  "Tentativa de pagamento com valor invÃ¡lido"
  plan_key: monthly
  amount: 1000 (tentou enviar valor menor)
  ip: 192.168.1.100
```

---

## 4. ValidaÃ§Ã£o CPF

```
CPF Input: "123.456.789-10"
           â†“ remove non-digits
           "12345678910"
           
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ isValidCpf($cpf)                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â”œâ”€ Tem 11 dÃ­gitos?
         â”‚  "12345678910" â†’ YES âœ“
         â”‚
         â”œâ”€ Todos iguais? (ex: 11111111111)
         â”‚  NO âœ“
         â”‚
         â”œâ”€ Valida 1Âº dÃ­gito verificador
         â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
         â”‚  â”‚ 1Ã—10 + 2Ã—9 + 3Ã—8 + ... â”‚
         â”‚  â”‚ = soma                  â”‚
         â”‚  â”‚ dÃ­gito = 11 - (soma%11) â”‚
         â”‚  â”‚ se â‰¥10 entÃ£o = 0        â”‚
         â”‚  â”‚ Compara com posiÃ§Ã£o [9] â”‚
         â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚  Match? YES âœ“
         â”‚
         â”œâ”€ Valida 2Âº dÃ­gito verificador
         â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
         â”‚  â”‚ 1Ã—11 + 2Ã—10 + 3Ã—9 + ..  â”‚
         â”‚  â”‚ = soma                  â”‚
         â”‚  â”‚ dÃ­gito = 11 - (soma%11) â”‚
         â”‚  â”‚ se â‰¥10 entÃ£o = 0        â”‚
         â”‚  â”‚ Compara com posiÃ§Ã£o [10]â”‚
         â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚  Match? YES âœ“
         â”‚
         â””â”€ VÃLIDO âœ…

Exemplos:
  "11111111111"  â†’ INVÃLIDO (todos iguais)
  "12345678901"  â†’ PODE SER (verifica dÃ­gitos)
  "000.000.000-00" â†’ INVÃLIDO (todos zeros)
```

---

## 5. Fluxo Completo de PIX (Visual)

```
USUÃRIO                 FRONTEND              BACKEND              MERCADO PAGO
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

    â†“ Abre modal
    â”‚
    â”œâ”€ Preenche:
    â”‚  â€¢ Nome Completo
    â”‚  â€¢ Email
    â”‚  â€¢ CPF
    â”‚  â€¢ Telefone (opt)
    â”‚           â†“
    â”‚      [Gerar PIX] â†â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚           â”‚                                                   â”‚
    â”‚           â””â”€â”€â†’ generatePixPayment()                          â”‚
    â”‚                â”œâ”€ Valida: nome, email, CPF (frontend)       â”‚
    â”‚                â”œâ”€ preparePIXData()                          â”‚
    â”‚                â”‚  â””â”€ Extrai: $totals['final_price']         â”‚
    â”‚                â”œâ”€ sendPixToBackend()                        â”‚
    â”‚                â”‚                                             â”‚
    â”‚                â””â”€â†’ POST /api/pix/create â”€â”€â”€â”€â”€â”€â”€â”€â†’ PixController
    â”‚                                                     â”‚
    â”‚                                    â”œâ”€ Valida dados
    â”‚                                    â”œâ”€ isValidAmountForPlan()
    â”‚                                    â”‚  â””â”€ GET /api/get-plans
    â”‚                                    â”œâ”€ isValidCpf()
    â”‚                                    â”œâ”€ Log auditoria
    â”‚                                    â””â”€â†’ Mercado Pago API â”€â”€â†’ createPixPayment()
    â”‚                                                              â”‚
    â”‚                                                              â”œâ”€ Gera QR Code
    â”‚                                                              â”œâ”€ Retorna payment_id
    â”‚                                    â†â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  â””â”€ Retorna data
    â”‚                                    â”‚
    â”‚    â†â”€â”€â”€â”€â”€â”€â”€â”€ JSON Response â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â”‚    â€¢ payment_id
    â”‚    â€¢ qr_code_base64
    â”‚    â€¢ qr_code (texto)
    â”‚    â€¢ amount
    â”‚    â€¢ status
    â”‚
    â””â”€â”€â†’ showPixModal = true
         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
         â”‚  MODAL PIX GERADO           â”‚
         â”‚                            â”‚
         â”‚  [QR CODE IMAGEM]          â”‚
         â”‚                            â”‚
         â”‚  CÃ³digo PIX:               â”‚
         â”‚  00020126580014br.gov.bcb  â”‚
         â”‚  brcode01051.0.031...      â”‚
         â”‚                            â”‚
         â”‚  Valor: R$ 29,80           â”‚
         â”‚  Status: Pendente          â”‚
         â”‚                            â”‚
         â”‚  [ğŸ“‹ Copiar] [â†— Abrir App] â”‚
         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
              â”‚
              â”œâ”€ Polling: GET /api/pix/status/payment_id (a cada 3s)
              â”‚  â†“ Se ainda pendente, continua
              â”‚
              â”œâ”€ UsuÃ¡rio copia cÃ³digo
              â”‚  Abre app do banco
              â”‚  Faz PIX â”€â”€â”€â”€â†’ Mercado Pago recebe
              â”‚                â”‚
              â”‚                â””â”€â†’ Webhook: POST /webhooks/pix
              â”‚                    â””â”€ Notifica: Payment Confirmed
              â”‚
              â”œâ”€ Frontend vÃª polling retornar "paid"
              â”‚  â†“
              â””â”€â†’ showPixModal = false
                  Redireciona: /success
                  
                  âœ… PEDIDO CONFIRMADO
```

---

## 6. Estrutura de Dados

### Frontend envia (preparePIXData output):
```json
{
  "amount": 2980,
  "currency_code": "BRL",
  "plan_key": "monthly",
  "offer_hash": "hash_do_plano",
  "customer": {
    "name": "JoÃ£o da Silva",
    "email": "joao@email.com",
    "phone_number": "+55 11 98765-4321",
    "document": "12345678910"
  },
  "cart": [
    {
      "product_hash": "plan_hash",
      "title": "SnapHubb - Mensal",
      "price": 1990,
      "quantity": 1,
      "operation_type": 1
    },
    {
      "product_hash": "bump_hash",
      "title": "Add-on Premium",
      "price": 990,
      "quantity": 1,
      "operation_type": 2
    }
  ],
  "gateway": "mercadopago",
  "metadata": {
    "product_main_hash": "main_hash",
    "bumps_selected": "bump1,bump2",
    "utm_source": "google",
    "utm_medium": "cpc",
    "utm_campaign": "campaign_name",
    "language": "br",
    "payment_method": "pix"
  }
}
```

### Backend retorna (apÃ³s validaÃ§Ã£o):
```json
{
  "status": "success",
  "data": {
    "payment_id": 123456789,
    "qr_code_base64": "iVBORw0KGgoAAAANSUhEUgAA...",
    "qr_code": "00020126580014br.gov.bcb...",
    "amount": 2980,
    "expiration_date": "2025-11-17T10:30:00",
    "status": "pending"
  }
}
```

---

## 7. Tabela de ComparaÃ§Ã£o: Antes vs Depois

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Aspecto          â”‚ ANTES                   â”‚ DEPOIS               â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Processamento    â”‚ Frontend â†’ Mercado Pago â”‚ Frontend â†’ Backend    â”‚
â”‚ PIX              â”‚ (direto)                â”‚ â†’ Mercado Pago       â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ SincronizaÃ§Ã£o    â”‚ âŒ Valores podem        â”‚ âœ… Mesmo valor para  â”‚
â”‚ de Valor         â”‚   diferir entre         â”‚   Stripe e PIX       â”‚
â”‚                  â”‚   Stripe e PIX          â”‚                      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ ValidaÃ§Ã£o de     â”‚ âŒ Nenhuma              â”‚ âœ… Backend compara   â”‚
â”‚ Integridade      â”‚                         â”‚   com API            â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ SeguranÃ§a        â”‚ âŒ Frontend controla    â”‚ âœ… Backend valida    â”‚
â”‚ contra Tampering â”‚   valor (risco)         â”‚   tudo (seguro)      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ CPF              â”‚ âš ï¸ ValidaÃ§Ã£o bÃ¡sica     â”‚ âœ… DÃ­gitos           â”‚
â”‚ Validation       â”‚ (apenas formato)        â”‚   verificadores      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Logs de          â”‚ âŒ MÃ­nimos              â”‚ âœ… Auditoria         â”‚
â”‚ Auditoria        â”‚                         â”‚   completa (IP,      â”‚
â”‚                  â”‚                         â”‚   tentativas, etc)   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Tratamento de    â”‚ âŒ BÃ¡sico               â”‚ âœ… Robusto com       â”‚
â”‚ Erros            â”‚                         â”‚   mensagens claras   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ HTTP Status      â”‚ -                       â”‚ âœ… 201 Created       â”‚
â”‚ Codes            â”‚                         â”‚ âœ… 422 Validation    â”‚
â”‚                  â”‚                         â”‚ âœ… 500 Server Error  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## 8. Caminho de um Pagamento PIX Bem-Sucedido

```
Timeline:
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

T0 - UsuÃ¡rio clica "Gerar PIX"
    â”œâ”€ Frontend valida (nome, email, CPF)
    â””â”€ Caso sucesso: continua

T1 - Frontend envia POST /api/pix/create
    â”œâ”€ Headers: Accept: application/json
    â””â”€ Body: { amount, currency_code, plan_key, customer, cart, ... }

T2 - Backend recebe (PixController@create)
    â”œâ”€ Valida schema (amount, email, etc)
    â”œâ”€ Checa integridade: amount vs plan_key
    â”œâ”€ Valida CPF (11 dÃ­gitos + verificadores)
    â””â”€ Se tudo OK: continua

T3 - Backend chama Mercado Pago
    â”œâ”€ POST /v1/payments
    â””â”€ Response: payment_id, QR code, status

T4 - Backend retorna 201 Created
    â””â”€ Body: { status: "success", data: { payment_id, qr_code, ... } }

T5 - Frontend mostra Modal PIX
    â”œâ”€ Exibe QR Code (imagem)
    â”œâ”€ Exibe cÃ³digo em texto
    â”œâ”€ Inicia polling (GET /api/pix/status/payment_id)
    â””â”€ A cada 3s verifica se foi pago

T6 - UsuÃ¡rio faz o PIX
    â”œâ”€ Abre app do banco
    â”œâ”€ Escaneia QR code (ou copia cÃ³digo)
    â””â”€ Confirma pagamento

T7 - Banco processa
    â””â”€ Envia para Mercado Pago

T8 - Mercado Pago recebe pagamento
    â”œâ”€ Atualiza status: paid
    â””â”€ Envia webhook (futuro)

T9 - Frontend polling detecta: paid
    â”œâ”€ Fecha modal
    â”œâ”€ Mostra sucesso
    â””â”€ Redireciona para confirmaÃ§Ã£o

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
Tempo total: ~1-10 segundos (depende do banco)
```

---

## 9. Matriz de DecisÃ£o: ValidaÃ§Ã£o Frontend vs Backend

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ValidaÃ§Ã£o                â”‚ Frontend         â”‚ Backend              â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Nome obrigatÃ³rio         â”‚ âœ… Aviso rÃ¡pido  â”‚ âœ… ValidaÃ§Ã£o final   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Email vÃ¡lido             â”‚ âœ… filter_var()  â”‚ âœ… ValidaÃ§Ã£o final   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ CPF formato              â”‚ âœ… Regex         â”‚ âœ… DÃ­gitos           â”‚
â”‚                          â”‚                  â”‚   verificadores      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Amount correspondente    â”‚ âŒ NÃƒO (risco)   â”‚ âœ… SEMPRE (seguro)   â”‚
â”‚ ao plano                 â”‚                  â”‚   Busca API          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Bumps inclusos           â”‚ âœ… Mostra valor  â”‚ âœ… Valida total      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Currency suportada       â”‚ âœ… Aviso         â”‚ âœ… ValidaÃ§Ã£o final   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Rate limiting            â”‚ âŒ NÃƒO           â”‚ âœ… SIM (futuro)      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Duplicate submission     â”‚ âŒ NÃƒO           â”‚ âœ… SIM (futuro)      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

REGRA DE OURO:
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  Frontend: User Experience (feedback rÃ¡pido)
  Backend:  Security (validaÃ§Ã£o final)
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
```

---

**Diagrama Criado:** 16 de Novembro de 2025
**Status:** ImplementaÃ§Ã£o Completa âœ…
**PrÃ³ximo:** Webhooks para ConfirmaÃ§Ã£o de Pagamento
